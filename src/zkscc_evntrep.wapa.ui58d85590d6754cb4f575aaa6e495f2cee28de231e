sap.ui.define(["sap/m/MessageBox"],                                                                                                                                                                                                                            
    /**                                                                                                                                                                                                                                                        
    * @param {typeof sap.m.MessageBox} MessageBox                                                                                                                                                                                                              
    */                                                                                                                                                                                                                                                         
    function (MessageBox) {                                                                                                                                                                                                                                    
        "use strict";                                                                                                                                                                                                                                          
        return {                                                                                                                                                                                                                                               
            removeAttachment:                                                                                                                                                                                                                                  
                /**                                                                                                                                                                                                                                            
                 * @param { typeof sap.ui.base.Event } oControlEvent                                                                                                                                                                                           
                 */                                                                                                                                                                                                                                            
                function (oControlEvent) {                                                                                                                                                                                                                     
                    var item = oControlEvent.getParameters("item");                                                                                                                                                                                            
                    item.item.getBindingContext().delete();                                                                                                                                                                                                    
                },                                                                                                                                                                                                                                             
            uploadAttachment:                                                                                                                                                                                                                                  
                /**                                                                                                                                                                                                                                            
                 * @param { typeof sap.ui.base.Event } oControlEvent                                                                                                                                                                                           
                 */                                                                                                                                                                                                                                            
                function (oControlEvent) {                                                                                                                                                                                                                     
                    var item = oControlEvent.getParameters("item").item;                                                                                                                                                                                       
                    var oUploadSet = oControlEvent.getSource();                                                                                                                                                                                                
                    var oContext = item.getBindingContext();                                                                                                                                                                                                   
                    var oEntry = {                                                                                                                                                                                                                             
                        Filename: item.getProperty("fileName"),                                                                                                                                                                                                
                        mimetype: item.getProperty("mediaType")                                                                                                                                                                                                
                    };                                                                                                                                                                                                                                         
                    var sServiceNamespace = "com.sap.gateway.srvd.zkscctransorder.v0001.";                                                                                                                                                                     
                    var oView = sap.ui.getCore().byId("onpremreportevent::TransOrderExecObjectPage");                                                                                                                                                          
                    var reader = new FileReader();                                                                                                                                                                                                             
                    reader.onload = function (e) {                                                                                                                                                                                                             
                        var vContent = e.currentTarget.result;                                                                                                                                                                                                 
                        var oAction = oView.getModel().bindContext(sServiceNamespace + "createAttachment(...)", oContext);                                                                                                                                     
                        oAction = oAction.setParameter("title", oEntry.Filename);                                                                                                                                                                              
                        oAction = oAction.setParameter("value", vContent);                                                                                                                                                                                     
                        oAction = oAction.setParameter("mimetype", oEntry.mimetype);                                                                                                                                                                           
                        oAction.execute("confirm", false).then(                                                                                                                                                                                                
                            function (message) {                                                                                                                                                                                                               
                                oUploadSet.removeAllIncompleteItems();                                                                                                                                                                                         
                                oContext.refresh();                                                                                                                                                                                                            
                            }.bind(this),                                                                                                                                                                                                                      
                            function (error) {                                                                                                                                                                                                                 
                                MessageBox.error(error.message);                                                                                                                                                                                               
                                oUploadSet.removeAllIncompleteItems();                                                                                                                                                                                         
                            });                                                                                                                                                                                                                                
                        oView.getModel().submitBatch("confirm");                                                                                                                                                                                               
                    };                                                                                                                                                                                                                                         
                    reader.readAsDataURL(item.getFileObject());                                                                                                                                                                                                
                },                                                                                                                                                                                                                                             
            onOpenPressed: /**                                                                                                                                                                                                                                 
             * @param { typeof sap.ui.base.Event } oControlEvent                                                                                                                                                                                               
             */                                                                                                                                                                                                                                                
                function (oControlEvent) {                                                                                                                                                                                                                     
                    oControlEvent.preventDefault();                                                                                                                                                                                                            
                    var item = oControlEvent.getSource();                                                                                                                                                                                                      
                    var oItemBindingContext = item.getBindingContext();                                                                                                                                                                                        
                    var fileName = oItemBindingContext.getProperty("Filename");                                                                                                                                                                                
                    var promiseValue = oItemBindingContext.requestProperty("Value");                                                                                                                                                                           
                    /**                                                                                                                                                                                                                                        
                    * @param {any} value                                                                                                                                                                                                                       
                    */                                                                                                                                                                                                                                         
                    function success(value) {                                                                                                                                                                                                                  
                        /**                                                                                                                                                                                                                                    
                          * @param {RequestInfo} blobUrl                                                                                                                                                                                                       
                          * @param {string} cFileName                                                                                                                                                                                                          
                          */                                                                                                                                                                                                                                   
                        async function downloadFile(blobUrl, cFileName) {                                                                                                                                                                                      
                            let response = await fetch(blobUrl);                                                                                                                                                                                               
                            let data = await response.blob();                                                                                                                                                                                                  
                            let metadata = {                                                                                                                                                                                                                   
                                type: "application/octet-stream"                                                                                                                                                                                               
                            };                                                                                                                                                                                                                                 
                            let file = new File([data], cFileName, metadata);                                                                                                                                                                                  
                            const element = document.createElement("a");                                                                                                                                                                                       
                            element.download = cFileName;                                                                                                                                                                                                      
                            element.href = URL.createObjectURL(file);                                                                                                                                                                                          
                            element.click();                                                                                                                                                                                                                   
                        }                                                                                                                                                                                                                                      
                        downloadFile(value, fileName);                                                                                                                                                                                                         
                    }                                                                                                                                                                                                                                          
                    promiseValue.then(success);                                                                                                                                                                                                                
                }                                                                                                                                                                                                                                              
        };                                                                                                                                                                                                                                                     
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               